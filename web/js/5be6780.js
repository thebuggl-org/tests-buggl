(function(a){a.gallery=function(b){var c={cityUrl:"",fetchMoreUrl:""};b=a.extend({},c,b);Country=Backbone.Model.extend();Countries=Backbone.Collection.extend({model:Country,});CountryView=Backbone.View.extend({el:a("#country"),initialize:function(){_.bindAll(this,"render");this.cityCollection=this.options.cityCollection;this.parameters=this.options.parameters;this.collection.bind("add",this.render,this);this.template=_.template(a("#country_template").html())},events:{"change select":"search"},render:function(){renderedTemplate=this.template({countries:this.collection.toJSON()});this.$el.html(renderedTemplate);return this},search:function(d){id=a(d.currentTarget).val();this.parameters.set({country:id,page:1,city:0});this.cityCollection.trigger("changeCities",d)}});City=Backbone.Model.extend();Cities=Backbone.Collection.extend({model:City,url:b.cityUrl});CityView=Backbone.View.extend({el:a("#city"),initialize:function(){_.bindAll(this,"render","changeCities");this.parameters=this.options.parameters;this.collection.bind("changeCities",this.changeCities,this);this.collection.bind("sync",this.render,this);this.template=_.template(a("#city_template").html());this.render()},events:{"change select":"selectCity"},render:function(){renderedTemplate=this.template({cities:this.collection.toJSON()});this.$el.html(renderedTemplate);return this},changeCities:function(d){id=a(d.currentTarget).val();this.collection.fetch({data:{countryID:id}})},selectCity:function(d){var e=a(d.currentTarget).val();this.parameters.set({city:e,page:1,})}});SearchParams=Backbone.Model.extend({defaults:{page:1,country:0,city:0}});PaginationModel=Backbone.Model.extend({defaults:{softPageLimit:8,hardPageLimit:12},initialize:function(){_.bindAll(this,"changeTotalPages");var e=this.attributes.totalCount;var d=this.attributes.limit;var g=Math.ceil(e/d);var f=1;this.bind("change:totalCount",this.changeTotalPages,this);this.set({totalPages:g,currentPage:f,limit:d,totalCount:e})},changeTotalPages:function(){var e=this.get("totalCount");var d=this.get("limit");var f=Math.ceil(e/d);this.set({totalPages:f})}});PaginationView=Backbone.View.extend({el:a("#pagination"),initialize:function(){_.bindAll(this,"render","compute","changeCurrentPage");this.model=this.options.model;this.parameters=this.options.parameters;this.parameters.bind("changePage",this.changeCurrentPage,this);this.template=_.template(a("#pagination_template").html());this.model.bind("change:currentPage",this.compute,this);this.model.bind("change:totalPages",this.compute,this);this.model.bind("all",this.render,this);this.compute()},events:{"click a":"paginate"},render:function(){var d=this.template(this.model.toJSON());this.$el.empty().html(d);return this},paginate:function(d){d.preventDefault();nextPage=parseInt(a(d.currentTarget).attr("href"));this.model.set({currentPage:nextPage});this.parameters.set({page:nextPage})},compute:function(){var f=this.model.get("totalPages");var g=f>this.model.defaults.hardPageLimit?this.model.defaults.softPageLimit:this.model.defaults.hardPageLimit;var e=Math.ceil(this.model.get("currentPage")/g);var d=(e-1)*g+1;if(f>this.model.defaults.hardPageLimit){endPage=d+this.model.defaults.softPageLimit-1}else{endPage=f}if(endPage>f){endPage=f}currentPage=this.model.get("currentPage");next=currentPage+1;prev=currentPage-1;next=next<f?next:f;prev=prev==0?1:prev;this.model.set({startPage:d,endPage:endPage,next:next,prev:prev})},changeCurrentPage:function(){page=this.parameters.get("page");this.model.set({currentPage:page})}});Photo=Backbone.Model.extend();Photos=Backbone.Collection.extend({model:Photo,url:b.fetchMoreUrl,parse:function(d){this.trigger("changeTotalCount",d.count);return d.result}});ImageView=Backbone.View.extend({tagName:"li",className:"clearfix",initialize:function(){_.bindAll(this,"render");this.model=this.options.model;this.full=this.options.full;this.template=_.template(a("#image_content").html())},events:{"click a[name=view-full]":"view"},render:function(){this.$el.html(this.template(this.model.toJSON()));return this},view:function(d){d.preventDefault();this.full.trigger("changeModel",this.model)}});ThumbnailView=Backbone.View.extend({el:a("#main_content"),initialize:function(){_.bindAll(this,"render","renderImageView","fetchMore","changeCurrentPage");this.collection.bind("reset",this.render,this);this.collection.bind("sync",this.render,this);this.collection.bind("changeTotalCount",this.changeTotalCount,this);this.pagination=this.options.pagination;this.parameters=this.options.parameters;this.full=this.options.full;this.parameters.bind("change:page",this.changeCurrentPage,this);this.parameters.bind("change",this.fetchMore,this);this.template=_.template(a("#page_content").html());this.$el.append(this.template())},render:function(){this.$el.find("ul.image-list").empty();this.collection.each(this.renderImageView,this);return this},renderImageView:function(e){var d=new ImageView({model:e,full:this.full});this.$el.find("ul.image-list").append(d.render().el)},fetchMore:function(){self=this;this.collection.fetch({data:self.parameters.toJSON()})},changeTotalCount:function(d){this.pagination.set({totalCount:d})},changeCurrentPage:function(){this.pagination.set({currentPage:this.parameters.get("page")})}});return this}})(jQuery);