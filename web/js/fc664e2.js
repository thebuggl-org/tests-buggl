(function(a){a.travelguide=function(b){var c={fetchUrl:""};b=a.extend({},c,b);Parameters=Backbone.Model.extend({initialize:function(){this.set({country:0,category:0,page:1})}});FilterView=Backbone.View.extend({el:a("ul.site-admin-filter"),initialize:function(){_.bindAll(this,"changeCountry","changeCategory");this.parameters=this.options.parameters},events:{"change select#countrySelect":"changeCountry","change select#categorySelect":"changeCategory"},changeCategory:function(d){var e=a(d.currentTarget).val();this.parameters.set({category:e,page:1})},changeCountry:function(d){var e=a(d.currentTarget).val();this.parameters.set({country:e,page:1})}});TravelGuide=Backbone.Model.extend();TravelGuides=Backbone.Collection.extend({model:TravelGuide,url:b.fetchUrl,parse:function(d){this.trigger("changeTotalCount",d.count);return d.data}});TravelGuidesView=Backbone.View.extend({el:a("div#guides_container"),initialize:function(){_.bindAll(this,"render","changeTotalCount","search");this.collection.bind("sync",this.render,this);this.collection.bind("changeTotalCount",this.changeTotalCount,this);this.pagination=this.options.pagination;this.parameters=this.options.parameters;this.parameters.bind("change",this.search,this);this.eventListener=this.options.eventListener;this.eventListener.bind("removeList",this.search,this);this.template=_.template(a("#eguide_list_container").html());this.$el.append(this.template)},render:function(){this.$el.children("ul").empty();this.collection.each(this.renderGuide,this)},renderGuide:function(e){var d=new TravelGuideView({model:e,pagination:this.pagination,collection:this.collection,eventListener:this.eventListener});this.$el.children("ul").append(d.render().el)},changeTotalCount:function(d){this.pagination.set({totalCount:d})},search:function(){var d=this.parameters.toJSON();this.collection.fetch({data:d,type:"post"})}});TravelGuideView=Backbone.View.extend({tagName:"li",className:"clearfix",initialize:function(){_.bindAll(this,"render","changeStatus","showModal");this.model=this.options.model;this.pagination=this.options.pagination;this.eventListener=this.options.eventListener;this.template=_.template(a("#eguide_list").html());this.messageTemplate=_.template(a("#message_template").html())},events:{"click a[name=actions]":"changeStatus","click a[name=message]":"showModal",},render:function(){this.$el.html(this.template(this.model.toJSON()));return this},changeStatus:function(e){e.preventDefault();parent=this.$el;var d=a(e.currentTarget).attr("href");self=this;a.getJSON(d,{},function(g){parent.remove();var f=self.pagination.get("totalCount");self.pagination.set({totalCount:f-1});self.eventListener.trigger("removeList")})},showModal:function(e){e.preventDefault();var f={id:this.model.get("localAuthorId"),name:this.model.get("author")};var d=this.messageTemplate(f);a("#main_content").find("div.content").empty().html(d).parent().reveal()}});PaginationModel=Backbone.Model.extend({defaults:{softPageLimit:8,hardPageLimit:12},initialize:function(){_.bindAll(this,"changeTotalPages");var d=this.attributes.limit;var e=1;this.bind("change:totalCount",this.changeTotalPages,this);this.set({currentPage:e,limit:d,totalCount:0})},changeTotalPages:function(){var e=this.get("totalCount");var d=this.get("limit");var g=Math.ceil(e/d);this.set({totalPages:g});var f=this.get("currentPage");if(f>g&&g>0){this.set({currentPage:f-1})}}});PaginationView=Backbone.View.extend({el:a("#pagination"),initialize:function(){_.bindAll(this,"render","compute","changeCurrentPage","changeParametersPage");this.parameters=this.options.parameters;this.parameters.bind("change:page",this.changeCurrentPage,this);this.model=this.options.model;this.model.bind("change:currentPage",this.changeParametersPage,this);this.model.bind("change:currentPage",this.compute,this);this.model.bind("change:totalPages",this.compute,this);this.model.bind("all",this.render,this);this.template=_.template(a("#pagination_template").html())},events:{"click a":"paginate"},render:function(){var d=this.template(this.model.toJSON());this.$el.empty().html(d);return this},paginate:function(d){d.preventDefault();nextPage=parseInt(a(d.currentTarget).attr("href"));this.model.set({currentPage:nextPage});this.parameters.set({page:nextPage})},compute:function(){var f=this.model.get("totalPages");var g=f>this.model.defaults.hardPageLimit?this.model.defaults.softPageLimit:this.model.defaults.hardPageLimit;var e=Math.ceil(this.model.get("currentPage")/g);var d=(e-1)*g+1;if(f>this.model.defaults.hardPageLimit){endPage=d+this.model.defaults.softPageLimit-1}else{endPage=f}if(endPage>f){endPage=f}currentPage=this.model.get("currentPage");next=currentPage+1;prev=currentPage-1;next=next<f?next:f;prev=prev==0?1:prev;this.model.set({startPage:d,endPage:endPage,next:next,prev:prev})},changeCurrentPage:function(){page=this.parameters.get("page");this.model.set({currentPage:page})},changeParametersPage:function(){page=this.model.get("currentPage");this.parameters.set({page:page})}});EventListener=Backbone.Model.extend();return this}})(jQuery);